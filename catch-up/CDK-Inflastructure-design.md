# Infrastructure Design 

作成日: 2026/02/05

目的： インフラ設計を行うにあたって基礎的な知識をキャッチアップすること

関連文書： [04-infrastructure-design.md](../documents/04-infrastructure-design.md)

参考：
- [AWS CDK を使用してクラウドインフラストラクチャを開発およびデプロイするためのベストプラクティス](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/best-practices.html)
- [【初心者向け】AWS CDK 入門！完全ガイド](https://zenn.dev/issy/articles/zenn-cdk-overview)

情報が膨大であり、その情報を念入りに撮りにいくべきかわからなかったので、おおまかな要約をAIに依頼

---

## 前提知識

### 導入のメリット




---
## 1. 組織に関するベストプラクティス

成功のための組織体制と、ガバナンス（統制）のあり方について。

* **専門家チームの設置**: CDK導入を導く専門チーム（CCoEなど）を置き、標準策定や開発者のメンタリングを行う。
* **マルチアカウント戦略とランディングゾーン**: **AWS Control Tower** 等を用いて、安全でスケーラブルなマルチアカウント環境を事前に構築する。
* **開発者の自由度とパイプライン**: 開発者は個別のテスト用アカウントを持ち、自身の端末の延長としてデプロイできるべきである。本番環境へのデプロイは、**CDK Pipelines** を通じて自動化する。

### 💡 語句解説

* **CCoE (Cloud Center of Excellence)**: 組織横断でクラウド活用の推進、ガバナンス策定、ベストプラクティスの共有を担う専門組織。
* **ランディングゾーン**: ベストプラクティスに基づき、あらかじめセキュリティやネットワークが設定された、マルチアカウントの土台となる環境。

---

## 2. コーディングに関するベストプラクティス

コードの管理方法と、設計のシンプルさについて。

* **シンプルさの維持**: 最初は最小限に保ち、必要に応じて複雑さを加える。最初から全シナリオを想定する必要はない。
* **単一リポジトリ・単一パッケージからの開始**: アプリのエントリポイントとして単一のパッケージから開始する。複数アプリを一つにまとめると、爆風半径（影響範囲）を広げるため推奨されない。
* **インフラとランタイムコードの共存**: インフラ定義と、Lambda関数等の実行ロジック（ランタイムコード）は同じパッケージに含める。これにより同期してテストやバージョン管理ができる。

### 💡 語句解説

* **Package (パッケージ)**: 言語の管理単位（TypeScriptなら `package.json` があるフォルダ）。関連するコードや設定のひとまとまり。
* **Component (コンポーネント)**: 特定の要件を満たすためのコード、設定、リソースの集合体。CDKでは1つの「アプリ」がこれに対応する。
* **エントリポイント**: プログラム実行の開始点。CDKでは `bin/` 配下のファイル（スタックを呼び出すコード）を指す。
* **ランタイムコード**: Lambda関数内で動くビジネスロジックなど、インフラの上で実際に動作するコード。

---

## 3. コンストラクト（Construct）に関するベストプラクティス

再利用可能なモジュールとしてのコンストラクト開発。

* **モデル化はコンストラクト、デプロイはスタック**: 論理的な単位（ウェブサイト等）は `Construct` として実装し、`Stack` はそれらをデプロイ用に接続するためにのみ使用する。
* **プロパティによる設定**: コンストラクト内での環境変数の参照はアンチパターン。設定は `Props`（プロパティオブジェクト）を通じて受け取り、コード上で制御可能にする。
* **ステートフルリソースのID固定**: データベース等の**論理ID**を変更すると、リソースの置換（データ消失）を招く。これが固定されていることをユニットテストで検証すべきである。

### 💡 語句解説

* **Construct (コンストラクト)**: CDKの最小構成単位。AWSリソースを組み合わせた再利用可能なコンポーネント。
* **Stack (スタック)**: AWS CloudFormation のスタックに対応する、デプロイの最小単位。
* **論理ID (Logical ID)**: CloudFormationテンプレート内でリソースを一意に識別するためのID。これが変わるとAWSは「別物」と判断して作り直す。

---

## 4. アプリケーションに関するベストプラクティス

リソース間の接続とデプロイの安定性について。

* **決定は合成時（Synthesis）に行う**: CloudFormationの `Parameters` 等を使用せず、言語の `if` 文などを用いて、CDKコードがテンプレートを生成する段階で判断を下す。
* **物理名の使用を避ける**: バケット名などをハードコード（直接記述）せず、CDKによる自動生成に任せる。これにより名前の衝突を回避できる。
* **ステートフル・スタックの分離**: ステートフルなリソース（DB等）は、ステートレスなリソース（Lambda等）とは別のスタックに分ける。
* **決定論的（Deterministic）な動作**: `cdk.context.json` をコミットし、常に同じテンプレートが生成されるようにする（最新AMI IDの取得結果などをキャッシュする）。
* **最小権限の付与**: CDKの `grant` メソッド（例：`table.grantReadData(lambda)`）を使用して、必要最小限の IAM 権限を自動生成させる。

### 💡 語句解説

* **Synthesis (合成)**: CDKプログラムを実行し、CloudFormationテンプレートを出力するプロセス。
* **ステートフル (Stateful)**: DBやS3など、データを保持し、削除すると復旧が困難なリソース。
* **ステートレス (Stateless)**: Lambdaなど、データを保持せず、何度でも安全に作り直しができるリソース。


## まとめ：MyBlog-AWS プロジェクトへの適用

アイルランドでの仕事においても、これらは「共通言語」となる。あなたのプロジェクトでは、まず以下の構成からスタートするのが正解だ。

1. **フォルダ構成**: `MyBlog-AWS` フォルダ（**単一パッケージ**）内に、インフラ定義と Lambda コードを全て入れる。
2. **スタック分割**: `DataStack`（**ステートフル**）と `AppStack`（**ステートレス**）の2つに分ける。
3. **名前管理**: テーブル名などの**物理名**を指定せず、CDK に任せる。
4. **権限管理**: `grant` メソッドで安全に権限を付与する。

