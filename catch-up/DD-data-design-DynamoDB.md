# DynamoDBデータ設計：ベストプラクティスと実践

> 作成日: 2026/02/03
> **目的**: DynamoDBを使った効率的なデータ設計手法を習得する  
> **前提知識**: [DD-fundamental-DynamoDB.md](./DD-fundamental-DynamoDB.md) - DynamoDBの基礎を理解済み  
> **参考**: [AWS公式: ベストプラクティス](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/best-practices.html)  
> **関連**: [documents/02-2-data-design.md](../documents/02-2-data-design.md) - MyBlogプロジェクトのデータ設計

---

## 1. DynamoDB設計の基本原則

### 1.1 RDBMSとの設計思想の違い

| 観点 | RDBMS | DynamoDB (NoSQL) |
|------|-------|------------------|
| **設計の出発点** | データの構造（エンティティ） | アクセスパターン（クエリ） |
| **正規化** | 重複排除のため正規化 | パフォーマンスのため非正規化 |
| **クエリ** | 後から柔軟にJOIN | 事前定義が必須 |
| **テーブル数** | 多数のテーブルに分割 | 可能な限り単一テーブル |
| **最適化の焦点** | ストレージ効率 | クエリ速度とコスト |

### 1.2 設計プロセス

> The first step in designing your DynamoDB application is to identify the specific query patterns that the system must satisfy.
> 
引用: [Approaching NoSQL Design](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-general-nosql-design.html#bp-general-nosql-design-approach)

まず、3つの基本的なアプリケーションに関するについて理解する必要がある。
1. Data size : そのくらいのデータが保存され、一度にリクエストを受け取るか -> Partirionの方法を決定する指標になる。
2. Data shape : 使用するクエリを基準にデータを設計する
3. Data Velocity : ピーク時のクエリ負荷を事前に把握することでI/O容量を最大限に活用するためのデータパーティション分割方法を決定するのに役立つ



```
1. アクセスパターンの洗い出し
   ↓
2. エンティティ関係図（ER図）の作成
   ↓
3. PK/SK設計（シングルテーブルデザイン検討）
   ↓
4. GSI設計（追加のアクセスパターン対応）
   ↓
5. サンプルデータでの検証
   ↓
6. パフォーマンステストとコスト試算
```

1によって特定のクエリ要件を特定したら、パフォーマンスを管理する一般的な原則に従ってデータを整理できる

### a. 関連するデータは一箇所にまとめる (Keep related data together)

* **概念**: 「Locality of Reference（参照の局所性）」を重視する。RDBMSのようにテーブルを分けるのではなく、1回のクエリで必要な情報をすべて取得できる場所にデータを配置する。
* **MyBlog-AWSへの適用**: 記事本体の `PK` に対して、`SK` を使い分けることで「記事のメタデータ」と「コメント」を同じパーティションに同居させる設計がこれに当たる。

### b. テーブル数は最小限にする (Maintain as few tables as possible)

* **概念**: 1つのテーブルに「反転インデックス（Inverted Indexes）」などを組み合わせることで、複雑な階層構造も1つのテーブルで表現できる。
* **例外**: 膨大な量の時系列データ（ログなど）や、全く異なるアクセスパターンを持つデータセット（例：ユーザー認証情報とブログ記事本文）は、管理やコストの観点から分離を検討する。

### c. ソート順を活用する (Use sort order)

* **概念**: 関連するアイテムを「ソートされる順序」を計算して配置することで、効率的にグループ化し、範囲検索（Query）を行う。
* **MyBlog-AWSへの適用**: `CreatedAt`（作成日）をソートキーに含めることで、特別な処理なしに「最新記事から順に取得」できるのはこの原則を利用している。

### d. クエリを分散させる (Distribute queries)

* **概念**: I/O容量を超えないよう、トラフィックをパーティション全体に均等に分散させる設計を行う。
* **注意点**: ノートにまとめた「ホットパーティション」を避けるための設計だ。特定のPKにアクセスが集中しないよう、カーディナリティ（値のバリエーション）の高い項目をキーに選定する。

### e. グローバルセカンダリインデックスの活用 (Use GSIs)

* **概念**: メインのテーブル構造（PK/SK）では対応できない「別の切り口での検索」を、高速かつ安価に実現するためにGSIを作成する。
* **MyBlog-AWSへの適用**: 「タグ別の一覧表示」や「下書き状態の記事のみの抽出」など、記事ID以外の条件で高速に検索したい場合に明示的に定義する。
---

## 2.コスト最適化の話
詳細：[コスト最適化 - AWS デベロッパーガイド](https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/bp-cost-optimization.html)

### 利用可能なテーブルキャパシティモード

DynamoDBのキャパシティ管理における2つのモード、**オンデマンド（On-Demand）** と **プロビジョンド（Provisioned）** の違いについて解説する。

ノートに記載した「1CU = 1秒間に1KBのR/W」という定義が、コストとパフォーマンスにどう反映されるかを理解する上で不可欠な概念だ。


####  2.1. オンデマンドモード (On-Demand)

リクエストがあった分だけ料金を支払う「完全従量課金」モデル。

**特徴**:
* **予測不要**: 事前にRCU/WCUの値を設定する必要がない。
* **即時スケール**: トラフィックの急増（スパイク）に対して、DynamoDBが自動でキャパシティを調整する。


**メリット**:
* アクセス数が予測できない、または変動が激しい場合に適している。
* 「MyBlog-AWS」の初期段階のように、いつ誰が見に来るか分からない状況に最適だ。


**コスト**:
* 100万リクエスト単位での課金。単価はプロビジョンドよりも高めに設定されている。



####  2.2. プロビジョンドモード (Provisioned)

「1秒間に何回の読み書きを行うか」を事前に予約しておくモデル。

**特徴**:
* **RCU/WCUの指定**: 自分でキャパシティの値を設定する（例：5 RCU, 5 WCU）。
* **Auto Scaling**: 指定した範囲内で、負荷に応じて自動増減させる設定も可能。


**メリット**:
* トラフィックが安定している場合、オンデマンドよりも**大幅にコストを抑えられる**。
* 無料利用枠（Free Tier）が適用されるのはこちらのモードである。


**コスト**:
* 実際にリクエストがあったかどうかに関わらず、予約したキャパシティに対して「時間単位」で課金される。


#### 2.3. どちらを選ぶべきか？

| 比較項目 | オンデマンド | プロビジョンド |
| --- | --- | --- |
| **運用の手間** | ほぼゼロ。おまかせ。 | トラフィック予測と設定が必要。 |
| **スループット** | リクエストに応じて無限にスケール。 | 設定値（予約分）まで。超えるとエラー。 |
| **コスト構造** | 使った分だけ（単価高め）。 | 予約枠（単価安め）。 |
| **適したフェーズ** | 開発初期、予測不能なバースト。 | 本番運用、安定したトラフィック。 |


####  2.4. 本プロジェクトでは... (あとで移動する)

あなたのプロジェクトにおける方針を提案する。

* **開発・初期運用**: **プロビジョンドモード（Auto Scalingなし、最小値5）** を推奨する。
* **理由**: AWS無料利用枠を活用できるため、コストを  に抑えて学習を継続できるからだ。


* **アイルランド移住後、記事がバズった時**: **オンデマンドモード** への切り替えを検討する。
* **理由**: 世界中からのアクセススパイク（ホットパーティション気味のアクセス）に対しても、管理の手間なく安定してミリ秒単位の応答を維持できるからだ。
---

## 3. Partition Key の設計
Amazon DynamoDB テーブルの各項目を一意に識別する主キーは、
- シンプル (パーティションキーのみ)
- 複合 (パーティションキーとソートキーの組み合わせ) 

で構成できる。

