#!/bin/bash

# CDK Outputs ã‹ã‚‰ .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆ/æ›´æ–°ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«å®Ÿè¡Œã—ã¦ç’°å¢ƒå¤‰æ•°ã‚’æœ€æ–°åŒ–

set -e

# ã‚«ãƒ©ãƒ¼å‡ºåŠ›
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
ENV_FILE="$PROJECT_ROOT/.env"

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘     Syncing .env from CDK Outputs          â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# AWS Profile ã®ç¢ºèª
AWS_PROFILE="${AWS_PROFILE:-myblog-dev}"
echo -e "${YELLOW}Using AWS Profile: $AWS_PROFILE${NC}"
echo ""

# CDK Outputs ã‚’å–å¾—
echo -e "${BLUE}ðŸ” Fetching CDK Stack Outputs...${NC}"

# DataStack Outputs
echo -e "${BLUE}  - DataStack outputs${NC}"
DATA_STACK_OUTPUTS=$(aws cloudformation describe-stacks \
  --stack-name MyBlog-DataStack \
  --profile "$AWS_PROFILE" \
  --query 'Stacks[0].Outputs' \
  --output json 2>/dev/null)

if [ $? -ne 0 ] || [ -z "$DATA_STACK_OUTPUTS" ]; then
  echo -e "${RED}âŒ Failed to get DataStack outputs${NC}"
  echo "Make sure the stack is deployed: cdk deploy MyBlog-DataStack"
  exit 1
fi

# AppStack Outputs
echo -e "${BLUE}  - AppStack outputs${NC}"
APP_STACK_OUTPUTS=$(aws cloudformation describe-stacks \
  --stack-name MyBlog-AppStack \
  --profile "$AWS_PROFILE" \
  --query 'Stacks[0].Outputs' \
  --output json 2>/dev/null)

if [ $? -ne 0 ] || [ -z "$APP_STACK_OUTPUTS" ]; then
  echo -e "${RED}âŒ Failed to get AppStack outputs${NC}"
  echo "Make sure the stack is deployed: cdk deploy MyBlog-AppStack"
  exit 1
fi

echo -e "${GREEN}âœ… Successfully fetched stack outputs${NC}"
echo ""

# Outputs ã‹ã‚‰å€¤ã‚’æŠ½å‡º
extract_output() {
  local outputs=$1
  local key=$2
  echo "$outputs" | jq -r ".[] | select(.OutputKey==\"$key\") | .OutputValue"
}

# DataStack ã®å€¤ã‚’æŠ½å‡º
COGNITO_USER_POOL_ID=$(extract_output "$DATA_STACK_OUTPUTS" "UserPoolId")
COGNITO_CLIENT_ID=$(extract_output "$DATA_STACK_OUTPUTS" "UserPoolClientId")
DYNAMODB_TABLE_NAME=$(extract_output "$DATA_STACK_OUTPUTS" "TableName")
MEDIA_BUCKET_NAME=$(extract_output "$DATA_STACK_OUTPUTS" "MediaBucketName")
MEDIA_CLOUDFRONT_DOMAIN=$(extract_output "$DATA_STACK_OUTPUTS" "MediaDistributionDomainName")

# AppStack ã®å€¤ã‚’æŠ½å‡º
API_URL=$(extract_output "$APP_STACK_OUTPUTS" "MyBlogApiEndpointC82E3489")
FRONTEND_BUCKET_NAME=$(extract_output "$APP_STACK_OUTPUTS" "FrontendBucketName")
FRONTEND_CLOUDFRONT_DOMAIN=$(extract_output "$APP_STACK_OUTPUTS" "DistributionDomainName")

# AWS_REGION ã‚’å–å¾—
AWS_REGION=$(aws configure get region --profile "$AWS_PROFILE" || echo "ap-northeast-1")

# æ—¢å­˜ã® .env ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¿æŒã™ã¹ãå€¤ã‚’èª­ã¿è¾¼ã¿
if [ -f "$ENV_FILE" ]; then
  echo -e "${BLUE}ðŸ“„ Reading existing .env file...${NC}"
  source "$ENV_FILE" 2>/dev/null || true
fi

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
if [ -f "$ENV_FILE" ]; then
  BACKUP_FILE="$ENV_FILE.backup.$(date +%Y%m%d_%H%M%S)"
  cp "$ENV_FILE" "$BACKUP_FILE"
  echo -e "${YELLOW}ðŸ“¦ Backup created: $BACKUP_FILE${NC}"
fi

# æ–°ã—ã„ .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
echo -e "${BLUE}âœï¸  Writing new .env file...${NC}"

cat > "$ENV_FILE" << EOF
# MyBlog Environment Configuration
# Auto-generated by scripts/sync-env.sh on $(date)
# âš ï¸ Do not commit this file to Git!

# ==============================================
# AWS Configuration
# ==============================================
AWS_PROFILE=${AWS_PROFILE}
AWS_REGION=${AWS_REGION}

# ==============================================
# API Configuration
# ==============================================
API_URL=${API_URL}

# ==============================================
# Cognito Configuration
# ==============================================
COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}

# ==============================================
# DynamoDB Configuration
# ==============================================
DYNAMODB_TABLE_NAME=${DYNAMODB_TABLE_NAME}

# ==============================================
# S3 & CloudFront Configuration
# ==============================================
# Media (User-uploaded content)
MEDIA_BUCKET_NAME=${MEDIA_BUCKET_NAME}
MEDIA_CLOUDFRONT_DOMAIN=${MEDIA_CLOUDFRONT_DOMAIN}

# Frontend (Website hosting)
FRONTEND_BUCKET_NAME=${FRONTEND_BUCKET_NAME}
FRONTEND_CLOUDFRONT_DOMAIN=${FRONTEND_CLOUDFRONT_DOMAIN}

# ==============================================
# Test User Credentials
# ==============================================
# Set your test user credentials here
TEST_USER_EMAIL=${TEST_USER_EMAIL:-your-email@example.com}
TEST_USER_PASSWORD=${TEST_USER_PASSWORD:-}

# ==============================================
# Optional: Manual JWT Token
# ==============================================
# If you want to use a manually obtained JWT token
# JWT_TOKEN=

# ==============================================
# Environment
# ==============================================
NODE_ENV=${NODE_ENV:-development}
EOF

echo -e "${GREEN}âœ… .env file updated successfully!${NC}"
echo ""

# çµæžœã‚’è¡¨ç¤º
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘           Updated Configuration            â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${YELLOW}AWS Configuration:${NC}"
echo "  AWS_PROFILE: $AWS_PROFILE"
echo "  AWS_REGION: $AWS_REGION"
echo ""
echo -e "${YELLOW}API:${NC}"
echo "  API_URL: $API_URL"
echo ""
echo -e "${YELLOW}Cognito:${NC}"
echo "  USER_POOL_ID: $COGNITO_USER_POOL_ID"
echo "  CLIENT_ID: $COGNITO_CLIENT_ID"
echo ""
echo -e "${YELLOW}DynamoDB:${NC}"
echo "  TABLE_NAME: $DYNAMODB_TABLE_NAME"
echo ""
echo -e "${YELLOW}S3 & CloudFront:${NC}"
echo "  MEDIA_BUCKET: $MEDIA_BUCKET_NAME"
echo "  MEDIA_CDN: $MEDIA_CLOUDFRONT_DOMAIN"
echo "  FRONTEND_BUCKET: $FRONTEND_BUCKET_NAME"
echo "  FRONTEND_CDN: $FRONTEND_CLOUDFRONT_DOMAIN"
echo ""

# è­¦å‘Š: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®š
if [ -z "$TEST_USER_PASSWORD" ] || [ "$TEST_USER_PASSWORD" == "" ]; then
  echo -e "${YELLOW}âš ï¸  Warning: TEST_USER_PASSWORD is not set${NC}"
  echo "Please edit .env and set your test user password:"
  echo "  vi .env"
  echo ""
fi

echo -e "${GREEN}ðŸŽ‰ Environment synchronization complete!${NC}"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo "  1. Edit .env to set TEST_USER_PASSWORD if needed"
echo "  2. Run tests: ./tests/api-test.sh"
echo ""
